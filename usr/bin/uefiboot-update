#!/bin/bash
# Set default cofinuration values 
ROOT=""
OPTIONS="ro quiet"

# read config file
if [ -x /etc/uefiboot.conf ] 
then
  source /etc/uefiboot.conf
fi

# if ROOT is not set then get root fs reference from /etc/fstab
if [[ "$ROOT" = "" ]]
then
  ROOT="$(sed '/^#.*/d;/ \/ /!d;s/ \/.*//' /etc/fstab)"
fi

# remove all Ubuntu boot options 
for OPT in $(efibootmgr | sed '/Boot[0-9].*Ubuntu/!d;s/Boot//;s/\*.*//')
do
  efibootmgr -Bb$OPT >/dev/null
done

# add new boot option according to installed kernels
echo "Updating UEFI boot options"

for KVER in $(ls /boot/vmlinuz* | sed 's/\/boot\/vmlinuz-//' | sort)
do
  echo -n "Kernel vmlinuz-$KVER found"
  efibootmgr -cl vmlinuz-$KVER -L "Ubuntu-"$KVER -u "root=$ROOT $OPTIONS initrd=initrd.img-$KVER" >/dev/null
  echo " ... added"
done